# test_app
test app

Такое вот тестовое задание, а именно разворачивание и запуск питоновского приложения через uwsgi + nginx. Впервые делаю подобную операцию, в своё время щупал ansible только на предмет установки приложений, используя пакетный менджер, да копирование файлов конфига. С питоновскими приложениями тоже практически не работал, максимум были кейсы, когда программистам нужно было просто запустить их приложение на сервере. Для меня на данный момент времени основную сложность вызвала именно собирание питоновского приложения (много времени ушло на то, чтобы разобраться, какие нужны дополнительные пакеты, а ещё были проблемы с тем, что в каждом дистрибутиве своя версия питона, свои версии дополнительных пакетов). В итоге были собраны пакеты приложений для Ubuntu 18.04 и CentOS 7, при которых приложение собиралось и было готово к запуску.

У меня был тестовый стенд на Hyper-V, состоящий из 2 клиентов (видно, какие это системы в файле hosts) и сервер ansible. Сначала я локально приложение собирал и запускал, убедился, что оно работает и стал наполнять playbook. 

Так как мы претендуем на некую универсальность (наш playbook умеет ставиться на 2 системы), то, в зависимости от того, какая перед нами система, то будут исполняться свои роли:

Для хостов с Ubuntu первым делом ставим необходимые пакеты (install_deb), затем ставим pip пакеты (pip3) — тут я нужные пакеты экспериментальным методом вычислял, без них не проходила сборка приложения. После этого устанавливаем postgresql11 и создаём базу и пользователя (install_postgres_deb), затем клонируем репозиторий с нужным приложением (clone_git). Собираем приложение (venv), даём права для пользователя www-data на нашу директорию с приложением (permissions_deb), копируем предварительно созданный файл wsgi.py для последующего запуска (copy_wsgi_deb), копируем оставшиеся файлы настроек и файл сервиса (copy_app_ini_deb). Ну и финальная роль start_service — там мы запускаем и ставим в автозагрузку службу для simple-python-app, а также перезапускаем службу nginx.

При таком деплое если зайти по айпишнику сервера в браузере, то мы увидим желанную надпись Hello World!, то есть статика отдаётся корректно. Запросы вида curl -i -X POST -d '{ "username": "user123", "email": "user@example.com", "password_hash": "example" }' -H "Content-Type: application/json" http://127.0.0.1/api/user отдают: HTTP/1.1 200 OK …
То есть приложение, по всей видимости, работает корректно.

Установка на CentOS аналогична, но я добавил ещё и роль для настройки фаервола и открытии порта 80 (в редакции Server Infrastructure firewalld включён, а при установке Ubuntu UFW в неактивном состоянии). Но приложение пока не запускается из-за selinux (выключать или ставить его в permissive не есть истинный путь), это я намерен исправить.
